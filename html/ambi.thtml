<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8"/>
      <title>Ambi</title>

      <script src="/javascripts/xml_actions.js" type="text/javascript"></script>
      <script src="/javascripts/ajax_get_handler.js" type="text/javascript"></script>
   </head>
   <body>

      <input id="search_input" type="text" value="">
      <input id="search_button" type="button" value="Watch" onclick="ajaxGetXmlRequest ('/onclick$search_button?search_input=' + document.getElementById('search_input').value);">

      <div id="search_results_list"></div>

      <div id="player"></div>

      <div id="playlist">@_PLAYLIST_@</div>

      <script>
         // State of the Youtube player
         var playerState = "end";

         // WebSocket to update playlist for all clients
         var ambiSocket = new WebSocket("ws://@_SERVER_ADDRESS_@/socket");

         ambiSocket.onmessage = function (event) {
            if (event.data == "update_client_playlist_request") {
               if (playerState != "play") {
                  ajaxGetXmlRequest ("/next_video", false);
                  location.reload();
               }
               else {
                  ajaxGetXmlRequest ("/get_playlist");
               }
            }
            //xmlActions(new window.DOMParser().parseFromString(event.data, "text/xml"));
         }

         // Function called when an item of search_results_list is clicked
         function select_result_item(elm) {
			   document.getElementById("search_input").value = "";
			   document.getElementById("search_results_list").innerHTML = "";

            ajaxGetRequestNoCallback ("/onclick$search_results_list?item=" + String(elm.getAttribute('value')));
         }

         ///////////////////////////////////////////////////////////////////////////////////////////
         // Youtube player script
         ///////////////////////////////////////////////////////////////////////////////////////////
         var tag = document.createElement('script');

         tag.src = "https://www.youtube.com/iframe_api";
         var firstScriptTag = document.getElementsByTagName('script')[0];
         firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

         var player;
         function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
               height: '360',
               width: '640',
               videoId: '@_VIDEO_ID_@',
               playerVars: { controls:1, showinfo: 0, rel: 0, showsearch: 0, iv_load_policy: 3, modestbranding: 1, enablejsapi: 1 },
               events: {
                 'onReady': onPlayerReady,
                 'onStateChange': onPlayerStateChange,
                 'onError': onPlayerError
               }
            });
         }

         function onPlayerReady(event) {
            playerState = "play";
            event.target.playVideo();
         }

         function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
               player.stopVideo();
               playerState = "end";

               if (document.getElementById("playlist").innerHTML != "<ul></ul>") {
                  ajaxGetXmlRequest ("/next_video", false);
                  location.reload();
               }
            }
         }

         function onPlayerError(event) {
            player.stopVideo();
            playerState = "error";

            if (document.getElementById("playlist").innerHTML != "<ul></ul>") {
               ajaxGetXmlRequest ("/next_video", false);
               location.reload();
            }
         }
         ///////////////////////////////////////////////////////////////////////////////////////////
         // End of Youtube player script
         ///////////////////////////////////////////////////////////////////////////////////////////
      </script>
   </body>
</html>
