<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8"/>
      <title>Ambi</title>

      <script src="/javascripts/xml_actions.js" type="text/javascript"></script>
      <script src="/javascripts/ajax_get_handler.js" type="text/javascript"></script>
   </head>

   <body>
      <input id="search_input" type="text" value="">
      <input id="search_button" type="button" value="Watch" onclick="ajaxGetXmlRequest('/onclick$search_button?search_input=' + document.getElementById('search_input').value);">

      <div>
         <input type="checkbox" id="player_display_checkbox" value="display_player" checked onclick="ajaxGetRequestNoCallback('/onclick$player_display_checkbox?checked=' + this.checked, true)">
         <label for="player_display_checkbox">Player</label>
      </div>

      <div>
         <input type="checkbox" id="player_sync_checkbox" value="sync_player" style="display:@_DISPLAY_SYNC_CHECKBOX_@" onclick="ajaxGetRequestNoCallback('/onclick$player_sync_checkbox?checked=' + this.checked, true)">
         <label for="player_sync_checkbox" style="display:@_DISPLAY_SYNC_CHECKBOX_@">Sync with room</label>
      </div>

      <div id="search_results"></div>

      <div id="player"></div>

      <p>Current room video: <div id="current_room_video">@_ROOM_VIDEO_@</div></p>

      <div>
         <button onclick="showPlaylist()">Playlist</button>
         <button onclick="showHistoric()">Historic</button>
         <button onclick="showLikes()">Likes</button>
      </div>

      <div id="video_list">@_VIDEO_LIST_@</div>

      <script>
         // State of the Youtube player
         var playerState = "@_PLAYER_STATE_@";

         if (playerState == "no_player") {
            document.getElementById("player_display_checkbox").checked = false;
         }
         else {
            document.getElementById("player_display_checkbox").checked = true;
         }

         // State of the video list
         var videoListState = "playlist";

         // WebSocket to update playlist and current room video for all clients
         var ambiSocket = new WebSocket("ws://@_SERVER_ADDRESS_@/socket");

         ambiSocket.onmessage = function (event) {
            if (event.data == "update_client_playlist_request") {
               if (playerState == "end" || playerState == "error") {
                  ajaxGetXmlRequest ("/next_video", true);
               }
               else {
                  if (videoListState == "playlist") {
                     ajaxGetXmlRequest ("/get_video_list?source=playlist");
                  }
               }
            }
            else if (event.data == "update_room_current_video_request") {
               if (videoListState == "historic") {
                  ajaxGetXmlRequest ("/get_video_list?source=historic");
               }
               else if (playerState == "no_player" && videoListState == "playlist") {
                  ajaxGetXmlRequest ("/get_video_list?source=playlist");
               }

               ajaxGetXmlRequest ("/get_current_room_video");
            }
            else if (event.data == "update_likes_request") {
               if (videoListState == "likes") {
                  ajaxGetXmlRequest ("/get_video_list?source=likes");
               }
            }
         }

         // Function called when an item of search_results or video_list is clicked
         function addToPlaylist(elm) {
            if (elm.getAttribute('name') == "search_results") {
               document.getElementById("search_input").value = "";
               document.getElementById("search_results").innerHTML = "";
            }

            ajaxGetRequestNoCallback ("/onclick$add_to_playlist?source=" + String(elm.getAttribute('name')) + "&item=" + String(elm.getAttribute('value')));
         }

         // Function called when a like button is clicked
         function addToLikes(elm) {
            ajaxGetRequestNoCallback ("/onclick$add_to_likes?source=" + String(elm.getAttribute('name')) + "&item=" + String(elm.getAttribute('value')));
         }

         function showPlaylist() {
            if (videoListState != "playlist") {
               videoListState = "playlist";
               ajaxGetXmlRequest ("/get_video_list?source=playlist");
            }
         }

         function showHistoric() {
            if (videoListState != "historic") {
               videoListState = "historic";
               ajaxGetXmlRequest ("/get_video_list?source=historic");
            }
         }

         function showLikes() {
            if (videoListState != "likes") {
               videoListState = "likes";
               ajaxGetXmlRequest ("/get_video_list?source=likes");
            }
         }
      </script>

	  <script id="youtube_player_script">@_YOUTUBE_PLAYER_SCRIPT_@</script>
   </body>
</html>
